<!doctype html>
<html lang="es" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-servicios-corporativos/servicio-identidad/decisiones-arquitectura" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">9. Decisiones de Arquitectura | Talma</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jclemente-tlm.github.io/tlm-doc-architecture/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jclemente-tlm.github.io/tlm-doc-architecture/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jclemente-tlm.github.io/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/decisiones-arquitectura"><meta data-rh="true" property="og:locale" content="es"><meta data-rh="true" name="docusaurus_locale" content="es"><meta data-rh="true" name="docsearch:language" content="es"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="9. Decisiones de Arquitectura | Talma"><meta data-rh="true" name="description" content="Esta sección documenta las decisiones arquitectónicas clave del Sistema de Identidad, siguiendo el formato ADR (Architecture Decision Record) y alineando cada decisión a los principios de portabilidad, estándares abiertos, multi-tenant y operación cloud-agnostic."><meta data-rh="true" property="og:description" content="Esta sección documenta las decisiones arquitectónicas clave del Sistema de Identidad, siguiendo el formato ADR (Architecture Decision Record) y alineando cada decisión a los principios de portabilidad, estándares abiertos, multi-tenant y operación cloud-agnostic."><link data-rh="true" rel="icon" href="/tlm-doc-architecture/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jclemente-tlm.github.io/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/decisiones-arquitectura"><link data-rh="true" rel="alternate" href="https://jclemente-tlm.github.io/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/decisiones-arquitectura" hreflang="es"><link data-rh="true" rel="alternate" href="https://jclemente-tlm.github.io/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/decisiones-arquitectura" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Servicios Corporativos","item":"https://jclemente-tlm.github.io/tlm-doc-architecture/docs/servicios-corporativos"},{"@type":"ListItem","position":2,"name":"Servicio de Identidad","item":"https://jclemente-tlm.github.io/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad"},{"@type":"ListItem","position":3,"name":"9. Decisiones de Arquitectura","item":"https://jclemente-tlm.github.io/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/decisiones-arquitectura"}]}</script><link rel="alternate" type="application/rss+xml" href="/tlm-doc-architecture/blog/rss.xml" title="Talma RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tlm-doc-architecture/blog/atom.xml" title="Talma Atom Feed"><link rel="stylesheet" href="/tlm-doc-architecture/assets/css/styles.b81aad75.css">
<script src="/tlm-doc-architecture/assets/js/runtime~main.72f14269.js" defer="defer"></script>
<script src="/tlm-doc-architecture/assets/js/main.ccd30d14.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/tlm-doc-architecture/img/logo-talma.png"><div role="region" aria-label="Saltar al contenido principal"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Saltar al contenido principal</a></div><nav aria-label="Principal" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Alternar barra lateral" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tlm-doc-architecture/"><div class="navbar__logo"><img src="/tlm-doc-architecture/img/logo-talma.png" alt="Talma Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/tlm-doc-architecture/img/logo-talma.png" alt="Talma Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tlm-doc-architecture/docs/intro">Documentación</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Cambiar entre modo oscuro y claro (actualmente system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Volver al principio" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Barra lateral de Documentos" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tlm-doc-architecture/docs/intro">Introducción</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/tlm-doc-architecture/docs/lineamientos">Lineamientos</a><button aria-label="Ampliar la categoría &#x27;Lineamientos&#x27; de la barra lateral" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/tlm-doc-architecture/docs/adrs">ADRs</a><button aria-label="Ampliar la categoría &#x27;ADRs&#x27; de la barra lateral" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/tlm-doc-architecture/docs/servicios-corporativos">Servicios Corporativos</a><button aria-label="Colapsar categoría &#x27;Servicios Corporativos&#x27; de la barra lateral" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/api-gateway">API Gateway</a><button aria-label="Ampliar la categoría &#x27;API Gateway&#x27; de la barra lateral" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad">Servicio de Identidad</a><button aria-label="Colapsar categoría &#x27;Servicio de Identidad&#x27; de la barra lateral" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/introduccion-objetivos">1. Introducción Y Objetivos Del Servicio De Identidad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/restricciones-arquitectura">2. Restricciones de la Arquitectura del Servicio de Identidad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/contexto-alcance">3. Contexto Y Alcance Del Servicio De Identidad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/estrategia-solucion">4. Estrategia De Solución</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/vista-bloques-construccion">5. Vista De Bloques De Construcción</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/vista-tiempo-ejecucion">6. Vista De Tiempo De Ejecución</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/vista-implementacion">7. Vista De Implementación</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/conceptos-transversales">8. Conceptos Transversales</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/decisiones-arquitectura">9. Decisiones de Arquitectura</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/requisitos-calidad">10. Requisitos De Calidad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/riesgos-deuda-tecnica">11. Riesgos Y Deuda Técnica</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/glosario">12. Glosario</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-mensajeria-sita">Servicio de Mensajería SITA</a><button aria-label="Ampliar la categoría &#x27;Servicio de Mensajería SITA&#x27; de la barra lateral" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-notificacion">Servicio de Notificación</a><button aria-label="Ampliar la categoría &#x27;Servicio de Notificación&#x27; de la barra lateral" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-track-trace">Servicio Track &amp; Trace</a><button aria-label="Ampliar la categoría &#x27;Servicio Track &amp; Trace&#x27; de la barra lateral" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tlm-doc-architecture/docs/aplicaciones">Aplicaciones</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tlm-doc-architecture/docs/capa-integracion">Capa de Integración</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Rastro de navegación"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Página de Inicio" class="breadcrumbs__link" href="/tlm-doc-architecture/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/tlm-doc-architecture/docs/servicios-corporativos"><span>Servicios Corporativos</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad"><span>Servicio de Identidad</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">9. Decisiones de Arquitectura</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">En esta página</button></div><div class="theme-doc-markdown markdown"><header><h1>9. Decisiones de Arquitectura</h1></header>
<p>Esta sección documenta las decisiones arquitectónicas clave del <strong>Sistema de Identidad</strong>, siguiendo el formato ADR (Architecture Decision Record) y alineando cada decisión a los principios de portabilidad, estándares abiertos, multi-tenant y operación cloud-agnostic.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="91-decisiones-principales">9.1 Decisiones Principales<a href="#91-decisiones-principales" class="hash-link" aria-label="Enlace directo al 9.1 Decisiones Principales" title="Enlace directo al 9.1 Decisiones Principales">​</a></h2>
<table><thead><tr><th>ADR</th><th>Decisión</th><th>Estado</th><th>Justificación</th></tr></thead><tbody><tr><td>ADR-001</td><td>Keycloak como IdP</td><td>Aceptado</td><td>Open source maduro</td></tr><tr><td>ADR-002</td><td>Multi-tenant (realm) por país</td><td>Aceptado</td><td>Aislamiento total</td></tr><tr><td>ADR-003</td><td>PostgreSQL backend</td><td>Aceptado</td><td>Robustez</td></tr><tr><td>ADR-004</td><td>Federación híbrida</td><td>Aceptado</td><td>Flexibilidad</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="92-alternativas-evaluadas">9.2 Alternativas Evaluadas<a href="#92-alternativas-evaluadas" class="hash-link" aria-label="Enlace directo al 9.2 Alternativas Evaluadas" title="Enlace directo al 9.2 Alternativas Evaluadas">​</a></h2>
<table><thead><tr><th>Componente</th><th>Alternativas</th><th>Selección</th><th>Razón</th></tr></thead><tbody><tr><td>IdP</td><td>Auth0, Okta, Keycloak</td><td>Keycloak</td><td>Control total</td></tr><tr><td>Base de datos</td><td>MySQL, PostgreSQL</td><td>PostgreSQL</td><td>Compatibilidad</td></tr><tr><td>Deployment</td><td>VM, Container, K8s</td><td>Container</td><td>Portabilidad</td></tr><tr><td>Federación</td><td>Full, None, Híbrida</td><td>Híbrida</td><td>Gradual</td></tr></tbody></table>
<blockquote>
<p>Todas las decisiones siguen los principios: agnóstico de nube, sin desarrollo personalizado, basado en estándares, multi-tenant (realm), contenedores primero, sin dependencia de proveedor. Cada ADR documenta contexto, justificación y consecuencias.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="93-resumen-de-decisiones">9.3 Resumen de Decisiones<a href="#93-resumen-de-decisiones" class="hash-link" aria-label="Enlace directo al 9.3 Resumen de Decisiones" title="Enlace directo al 9.3 Resumen de Decisiones">​</a></h2>
<table><thead><tr><th>#</th><th>Decisión</th><th>Estado</th><th>Impacto</th><th>Fecha</th></tr></thead><tbody><tr><td>ADR-001</td><td>Keycloak Containerizado</td><td>Aprobado</td><td>Alto</td><td>2024-01-15</td></tr><tr><td>ADR-002</td><td>Multi-tenant (realm)</td><td>Aprobado</td><td>Alto</td><td>2024-01-20</td></tr><tr><td>ADR-003</td><td>Database-backed Sessions</td><td>Aprobado</td><td>Medio</td><td>2024-01-25</td></tr><tr><td>ADR-004</td><td>OAuth2 + OIDC Standard</td><td>Aprobado</td><td>Alto</td><td>2024-01-30</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="94-principios-arquitectónicos">9.4 Principios Arquitectónicos<a href="#94-principios-arquitectónicos" class="hash-link" aria-label="Enlace directo al 9.4 Principios Arquitectónicos" title="Enlace directo al 9.4 Principios Arquitectónicos">​</a></h2>
<ul>
<li><strong>Portabilidad entre nubes:</strong> Keycloak y PostgreSQL desplegables en AWS, Azure, GCP o on-premise</li>
<li><strong>Sin desarrollo personalizado:</strong> Uso de Keycloak y PostgreSQL listos para usar</li>
<li><strong>Estándares abiertos:</strong> OAuth2, OIDC, SAML 2.0 para máxima interoperabilidad</li>
<li><strong>Multi-tenant (realm) por país:</strong> Aislamiento total de datos y configuración</li>
<li><strong>Contenedores y orquestación:</strong> Docker/Kubernetes como base de despliegue</li>
<li><strong>Independencia de proveedor:</strong> Sin lock-in, migración sencilla</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="95-referencias">9.5 Referencias<a href="#95-referencias" class="hash-link" aria-label="Enlace directo al 9.5 Referencias" title="Enlace directo al 9.5 Referencias">​</a></h2>
<ul>
<li><a href="https://docs.arc42.org/section-9/" target="_blank" rel="noopener noreferrer">Arc42 ADR Template</a></li>
<li><a href="https://www.keycloak.org/architecture/" target="_blank" rel="noopener noreferrer">Keycloak Architecture</a></li>
<li><a href="https://c4model.com/" target="_blank" rel="noopener noreferrer">C4 Model for Software Architecture</a></li>
</ul>
<hr>
<h1>9. Decisiones de arquitectura (Detalle ADR)</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="91-decisiones-principales-1">9.1 Decisiones principales<a href="#91-decisiones-principales-1" class="hash-link" aria-label="Enlace directo al 9.1 Decisiones principales" title="Enlace directo al 9.1 Decisiones principales">​</a></h2>
<table><thead><tr><th>ADR</th><th>Decisión</th><th>Estado</th><th>Justificación</th></tr></thead><tbody><tr><td><strong>ADR-001</strong></td><td>Keycloak como IdP</td><td>Aceptado</td><td>Open source maduro</td></tr><tr><td><strong>ADR-002</strong></td><td>Multi-realm por país</td><td>Aceptado</td><td>Aislamiento completo</td></tr><tr><td><strong>ADR-003</strong></td><td>PostgreSQL backend</td><td>Aceptado</td><td>Robustez</td></tr><tr><td><strong>ADR-004</strong></td><td>Federación híbrida</td><td>Aceptado</td><td>Flexibilidad</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="92-alternativas-evaluadas-1">9.2 Alternativas evaluadas<a href="#92-alternativas-evaluadas-1" class="hash-link" aria-label="Enlace directo al 9.2 Alternativas evaluadas" title="Enlace directo al 9.2 Alternativas evaluadas">​</a></h2>
<table><thead><tr><th>Componente</th><th>Alternativas</th><th>Selección</th><th>Razón</th></tr></thead><tbody><tr><td><strong>IdP</strong></td><td>Auth0, Okta, Keycloak</td><td>Keycloak</td><td>Control total</td></tr><tr><td><strong>Base datos</strong></td><td>MySQL, PostgreSQL</td><td>PostgreSQL</td><td>Compatibilidad</td></tr><tr><td><strong>Deployment</strong></td><td>VM, Container, K8s</td><td>Container</td><td>Portabilidad</td></tr><tr><td><strong>Federación</strong></td><td>Full, None, Híbrida</td><td>Híbrida</td><td>Gradual</td></tr></tbody></table>
<p>Esta sección documenta las decisiones arquitectónicas más importantes del <strong>Sistema de Identidad</strong> utilizando el formato ADR (Architecture Decision Record), proporcionando contexto, justificación y consecuencias de cada decisión.</p>
<p><em>[INSERTAR AQUÍ: Diagrama C4 - Architecture Decision Dependencies]</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resumen-de-decisiones-arquitectónicas">Resumen de Decisiones Arquitectónicas<a href="#resumen-de-decisiones-arquitectónicas" class="hash-link" aria-label="Enlace directo al Resumen de Decisiones Arquitectónicas" title="Enlace directo al Resumen de Decisiones Arquitectónicas">​</a></h2>
<table><thead><tr><th>#</th><th>Decisión</th><th>Estado</th><th>Impacto</th><th>Fecha</th></tr></thead><tbody><tr><td>ADR-001</td><td>Keycloak Containerizado</td><td>✅ Aprobado</td><td>Alto</td><td>2024-01-15</td></tr><tr><td>ADR-002</td><td>Multi-realm Strategy</td><td>✅ Aprobado</td><td>Alto</td><td>2024-01-20</td></tr><tr><td>ADR-003</td><td>Database-backed Sessions</td><td>✅ Aprobado</td><td>Medio</td><td>2024-01-25</td></tr><tr><td>ADR-004</td><td>OAuth2 + OIDC Standard</td><td>✅ Aprobado</td><td>Alto</td><td>2024-01-30</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="principios-arquitectónicos">Principios Arquitectónicos<a href="#principios-arquitectónicos" class="hash-link" aria-label="Enlace directo al Principios Arquitectónicos" title="Enlace directo al Principios Arquitectónicos">​</a></h3>
<p>Las decisiones arquitectónicas del Sistema de Identidad siguen los principios de:</p>
<ul>
<li><strong>Agnóstico de Nube:</strong> Keycloak contenedorizado portable entre AWS, Azure y GCP</li>
<li><strong>Cero Desarrollo Personalizado:</strong> Uso de Keycloak listo para usar sin modificaciones</li>
<li><strong>Basado en Estándares:</strong> OAuth2, OIDC, SAML 2.0 para máxima interoperabilidad</li>
<li><strong>Multi-tenant:</strong> Realms separados por país/tenant</li>
<li><strong>Contenedores Primero:</strong> Optimizado para Kubernetes y Docker</li>
<li><strong>Sin Dependencia de Proveedor:</strong> Libertad completa para moverse entre proveedores de nube</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adr-001-keycloak-containerizado-como-identity-provider-central">ADR-001: Keycloak Containerizado como Identity Provider Central<a href="#adr-001-keycloak-containerizado-como-identity-provider-central" class="hash-link" aria-label="Enlace directo al ADR-001: Keycloak Containerizado como Identity Provider Central" title="Enlace directo al ADR-001: Keycloak Containerizado como Identity Provider Central">​</a></h2>
<table><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody><tr><td><strong>Estado</strong></td><td>✅ Aprobado</td></tr><tr><td><strong>Fecha</strong></td><td>2024-01-15</td></tr><tr><td><strong>Decidido por</strong></td><td>Equipo de Arquitectura + CISO</td></tr><tr><td><strong>Interesados</strong></td><td>Equipos de Desarrollo, Equipo de Seguridad, Operaciones</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contexto">Contexto<a href="#contexto" class="hash-link" aria-label="Enlace directo al Contexto" title="Enlace directo al Contexto">​</a></h3>
<p>La organización requiere centralizar la gestión de identidades para múltiples aplicaciones corporativas distribuidas en 4 países (Perú, Ecuador, Colombia, México), con enfoque en <strong>portabilidad agnóstica de nube</strong> y sin desarrollo personalizado dentro del servicio de identidad.</p>
<p><strong>Requisitos específicos:</strong></p>
<ul>
<li>Solución contenedorizada lista para usar</li>
<li>Soporte para OAuth2/OIDC y SAML 2.0</li>
<li>Multi-tenancy con aislamiento por país</li>
<li>Federación con Google Workspace y Active Directory</li>
<li>Cumplimiento con GDPR, SOX y regulaciones locales</li>
<li><strong>Agnóstico de nube:</strong> Portable entre AWS, Azure, GCP</li>
<li><strong>Cero desarrollo personalizado:</strong> Usar Keycloak listo para usar</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alternativas-consideradas">Alternativas Consideradas<a href="#alternativas-consideradas" class="hash-link" aria-label="Enlace directo al Alternativas Consideradas" title="Enlace directo al Alternativas Consideradas">​</a></h3>
<table><thead><tr><th>Solución</th><th>Portabilidad</th><th>Desarrollo Custom</th><th>Costo/Año</th><th>Vendor Lock-in</th></tr></thead><tbody><tr><td><strong>Keycloak Container</strong></td><td>✅ Full</td><td>❌ None required</td><td>$50K</td><td>❌ None</td></tr><tr><td><strong>Auth0</strong></td><td>⚠️ Limited</td><td>❌ API only</td><td>$180K</td><td>✅ High</td></tr><tr><td><strong>AWS Cognito</strong></td><td>❌ AWS only</td><td>⚠️ Some custom</td><td>$120K</td><td>✅ Complete</td></tr><tr><td><strong>Azure AD B2C</strong></td><td>❌ Azure only</td><td>⚠️ Some custom</td><td>$150K</td><td>✅ Complete</td></tr><tr><td><strong>Custom Identity Service</strong></td><td>✅ Full</td><td>✅ Extensive</td><td>$200K+</td><td>❌ None</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decisión">Decisión<a href="#decisión" class="hash-link" aria-label="Enlace directo al Decisión" title="Enlace directo al Decisión">​</a></h3>
<p><strong>Adoptar Keycloak containerizado como proveedor de identidad central</strong> con deployment cloud-agnostic usando Docker/Kubernetes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arquitectura-containerizada">Arquitectura Containerizada<a href="#arquitectura-containerizada" class="hash-link" aria-label="Enlace directo al Arquitectura Containerizada" title="Enlace directo al Arquitectura Containerizada">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Keycloak Container Stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;3.8&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">keycloak</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/keycloak/keycloak</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KEYCLOAK_ADMIN=admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KEYCLOAK_ADMIN_PASSWORD=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ADMIN_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KC_DB=postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KC_DB_URL=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DATABASE_URL</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KC_DB_USERNAME=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_USERNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KC_DB_PASSWORD=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KC_HOSTNAME=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KEYCLOAK_HOSTNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> KC_PROXY=edge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">optimized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">spi</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">theme</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">static</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">max</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">age=</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">spi</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">theme</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">themes=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8080:8080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./themes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/opt/keycloak/themes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./providers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/opt/keycloak/providers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">postgres</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">15</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> POSTGRES_DB=keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> POSTGRES_USER=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_USERNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> POSTGRES_PASSWORD=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> postgres_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/var/lib/postgresql/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  postgres_data</span><span class="token punctuation" style="color:#393A34">:</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuración-multi-tenant-realms">Configuración Multi-tenant (Realms)<a href="#configuración-multi-tenant-realms" class="hash-link" aria-label="Enlace directo al Configuración Multi-tenant (Realms)" title="Enlace directo al Configuración Multi-tenant (Realms)">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Realm Configuration per Country</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Realms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">peru-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">external_idp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workspace</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">peru</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">compliance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GDPR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Local Peruvian Regulations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ecuador-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">external_idp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workspace</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecuador</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">compliance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GDPR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Local Ecuadorian Regulations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">colombia-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">external_idp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> microsoft</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ad</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">colombia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">compliance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GDPR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Local Colombian Regulations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">mexico-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">external_idp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workspace</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mexico</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">compliance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GDPR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Local Mexican Regulations</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="justificación">Justificación<a href="#justificación" class="hash-link" aria-label="Enlace directo al Justificación" title="Enlace directo al Justificación">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="portabilidad-y-vendor-independence">Portabilidad y Vendor Independence<a href="#portabilidad-y-vendor-independence" class="hash-link" aria-label="Enlace directo al Portabilidad y Vendor Independence" title="Enlace directo al Portabilidad y Vendor Independence">​</a></h4>
<ul>
<li>
<p><strong>Cloud Agnostic:</strong> Funciona en cualquier plataforma de containers</p>
</li>
<li>
<p><strong>Zero Lock-in:</strong> Open source, migratable a cualquier cloud</p>
</li>
<li>
<p><strong>Standard Protocols:</strong> OAuth2, OIDC, SAML - ampliamente soportados</p>
</li>
<li>
<p><strong>Container-first:</strong> Deploy en Kubernetes, Docker Swarm, o ECS</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="zero-custom-development">Zero Custom Development<a href="#zero-custom-development" class="hash-link" aria-label="Enlace directo al Zero Custom Development" title="Enlace directo al Zero Custom Development">​</a></h4>
<ul>
<li>
<p><strong>Out-of-the-box Features:</strong> Todo lo requerido está incluido</p>
</li>
<li>
<p><strong>Configuration-only:</strong> Solo archivos YAML y environment variables</p>
</li>
<li>
<p><strong>Theme Customization:</strong> Branding via templates, no código</p>
</li>
<li>
<p><strong>SPI Plugins:</strong> Extensiones disponibles sin desarrollo</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="operacional-simplicity">Operacional Simplicity<a href="#operacional-simplicity" class="hash-link" aria-label="Enlace directo al Operacional Simplicity" title="Enlace directo al Operacional Simplicity">​</a></h4>
<ul>
<li><strong>Infraestructura como Código:</strong> Reproducible deployments</li>
<li><strong>Health Checks:</strong> Built-in readiness/liveness probes</li>
<li><strong>Monitoring:</strong> Metrics endpoint para Prometheus</li>
<li><strong>Backup/Restore:</strong> Database backup strategy</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementación-cloud-agnostic">Implementación Cloud-Agnostic<a href="#implementación-cloud-agnostic" class="hash-link" aria-label="Enlace directo al Implementación Cloud-Agnostic" title="Enlace directo al Implementación Cloud-Agnostic">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Kubernetes Deployment (portable across clouds)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/keycloak/keycloak</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KEYCLOAK_ADMIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keycloak</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KEYCLOAK_ADMIN_PASSWORD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keycloak</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KC_DB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;postgres&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KC_DB_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">configMapKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keycloak</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> database</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">readinessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">httpGet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /health/ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">initialDelaySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">periodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">livenessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">httpGet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /health/live</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">initialDelaySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">periodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consecuencias">Consecuencias<a href="#consecuencias" class="hash-link" aria-label="Enlace directo al Consecuencias" title="Enlace directo al Consecuencias">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="positivas">Positivas<a href="#positivas" class="hash-link" aria-label="Enlace directo al Positivas" title="Enlace directo al Positivas">​</a></h4>
<ul>
<li>✅ <strong>Cero desarrollo:</strong> No se requiere código personalizado</li>
<li>✅ <strong>Portabilidad de nube:</strong> Ejecutar donde sea que se soporten contenedores</li>
<li>✅ <strong>Rentable:</strong> $50K/año vs $180K+ soluciones administradas</li>
<li>✅ <strong>Control completo:</strong> Flexibilidad de configuración completa</li>
<li>✅ <strong>Basado en estándares:</strong> Cumplimiento OAuth2, OIDC, SAML</li>
<li>✅ <strong>Listo para empresa:</strong> Multi-tenancy, federación, rastros de auditoría</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="negativas">Negativas<a href="#negativas" class="hash-link" aria-label="Enlace directo al Negativas" title="Enlace directo al Negativas">​</a></h4>
<ul>
<li>❌ <strong>Responsabilidad operacional:</strong> Infraestructura auto-administrada</li>
<li>❌ <strong>Expertise requerido:</strong> El equipo necesita conocimiento de Keycloak</li>
<li>❌ <strong>Overhead de mantenimiento:</strong> Actualizaciones, parches, monitoreo</li>
<li>❌ <strong>Sin soporte de proveedor:</strong> Solo soporte de comunidad (a menos que suscripción Red Hat)</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mitigaciones">Mitigaciones<a href="#mitigaciones" class="hash-link" aria-label="Enlace directo al Mitigaciones" title="Enlace directo al Mitigaciones">​</a></h4>
<ul>
<li>🔧 <strong>Automatización de infraestructura:</strong> Terraform, Helm charts para despliegue</li>
<li>🔧 <strong>Stack de monitoreo:</strong> Prometheus, Grafana para observabilidad</li>
<li>🔧 <strong>Estrategia de respaldo:</strong> Respaldos automáticos de base de datos</li>
<li>🔧 <strong>Capacitación del equipo:</strong> Certificación de administración de Keycloak</li>
<li>🔧 <strong>Opción de soporte:</strong> Suscripción Red Hat para soporte de producción</li>
<li>🔧 <strong>Documentación:</strong> Manuales operacionales completos</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adr-002-jwt-con-rs256-como-formato-de-token-estándar">ADR-002: JWT con RS256 como Formato de Token Estándar<a href="#adr-002-jwt-con-rs256-como-formato-de-token-estándar" class="hash-link" aria-label="Enlace directo al ADR-002: JWT con RS256 como Formato de Token Estándar" title="Enlace directo al ADR-002: JWT con RS256 como Formato de Token Estándar">​</a></h2>
<table><thead><tr><th>Campo</th><th>Valor</th></tr></thead></table>
<p>| <strong>Estado</strong> | ✅ Aprobado |
| <strong>Fecha</strong> | 2024-01-20 |
| <strong>Decidido por</strong> | Equipo de Seguridad + Engineering Lead |
| <strong>Relacionado con</strong> | ADR-001 (Keycloak), ADR-004 (Token Caching) |</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contexto-1">Contexto<a href="#contexto-1" class="hash-link" aria-label="Enlace directo al Contexto" title="Enlace directo al Contexto">​</a></h3>
<p>Los microservicios requieren un mecanismo de autenticación/autorización que sea:</p>
<ul>
<li><strong>Stateless:</strong> Sin dependency en session storage</li>
<li><strong>Performant:</strong> Validación rápida sin round-trips</li>
<li><strong>Secure:</strong> Integridad y no-repudiation</li>
<li><strong>Standard:</strong> Amplio soporte en librerías</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alternativas-consideradas-1">Alternativas Consideradas<a href="#alternativas-consideradas-1" class="hash-link" aria-label="Enlace directo al Alternativas Consideradas" title="Enlace directo al Alternativas Consideradas">​</a></h3>
<table><thead><tr><th>Formato</th><th>Pros</th><th>Contras</th><th>Decisión</th></tr></thead><tbody><tr><td><strong>JWT RS256</strong></td><td>Stateless, signature verification, standard</td><td>Larger size, key management</td><td>✅ <strong>Seleccionado</strong></td></tr><tr><td><strong>Opaque Tokens</strong></td><td>Small size, easy revocation</td><td>Requires introspection endpoint</td><td>❌ Rechazado</td></tr><tr><td><strong>JWT HS256</strong></td><td>Smaller, symmetric</td><td>Shared secret distribution</td><td>❌ Rechazado</td></tr><tr><td><strong>PASETO</strong></td><td>Modern, secure by default</td><td>Limited library support</td><td>❌ Rechazado</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decisión-1">Decisión<a href="#decisión-1" class="hash-link" aria-label="Enlace directo al Decisión" title="Enlace directo al Decisión">​</a></h3>
<p><strong>Utilizar JWT (JSON Web Tokens) con algoritmo de firma RS256</strong> para todos los access tokens.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="justificación-1">Justificación<a href="#justificación-1" class="hash-link" aria-label="Enlace directo al Justificación" title="Enlace directo al Justificación">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seguridad">Seguridad<a href="#seguridad" class="hash-link" aria-label="Enlace directo al Seguridad" title="Enlace directo al Seguridad">​</a></h4>
<ul>
<li><strong>Firmas asimétricas:</strong> Verificación de clave pública, firma de clave privada</li>
<li><strong>No repudio:</strong> Prueba criptográfica de autenticidad del token</li>
<li><strong>Sin secretos compartidos:</strong> Elimina problemas de distribución de secretos</li>
<li><strong>Cumplimiento de estándares:</strong> RFC 7519, mejores prácticas de la industria</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rendimiento">Rendimiento<a href="#rendimiento" class="hash-link" aria-label="Enlace directo al Rendimiento" title="Enlace directo al Rendimiento">​</a></h4>
<ul>
<li><strong>Validación sin estado:</strong> No se requiere búsqueda en base de datos</li>
<li><strong>Verificación local:</strong> Cada servicio valida independientemente</li>
<li><strong>Amigable con caché:</strong> Claves públicas cacheadas con TTL largo</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="operacional">Operacional<a href="#operacional" class="hash-link" aria-label="Enlace directo al Operacional" title="Enlace directo al Operacional">​</a></h4>
<ul>
<li><strong>Herramientas estándar:</strong> Amplio soporte de bibliotecas (.NET, Java, Node.js)</li>
<li><strong>Amigable para debugging:</strong> Payload legible para humanos</li>
<li><strong>Basado en claims:</strong> Contexto rico en payload del token</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="token-structure">Token Structure<a href="#token-structure" class="hash-link" aria-label="Enlace directo al Token Structure" title="Enlace directo al Token Structure">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;header&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;alg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RS256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;typ&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;JWT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;kid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;realm-key-id&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;payload&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;iss&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://identity.talma.pe/auth/realms/peru&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;sub&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user-uuid&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;aud&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;notification-api&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;track-trace-api&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;exp&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1640995200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;iat&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1640991600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;jti&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;token-uuid&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;tenant&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;peru&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;roles&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;employee&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;notification-user&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;scope&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;openid profile email&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;department&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;IT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;country&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-management-strategy">Key Management Strategy<a href="#key-management-strategy" class="hash-link" aria-label="Enlace directo al Key Management Strategy" title="Enlace directo al Key Management Strategy">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Key Rotation Policy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Primary Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Lifetime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 90 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Algorithm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RSA</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Auto-rotation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Secondary Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Lifetime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 30 days overlap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Purpose</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Validation during rotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Emergency Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Purpose</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Security incident response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Manual activation only</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consecuencias-1">Consecuencias<a href="#consecuencias-1" class="hash-link" aria-label="Enlace directo al Consecuencias" title="Enlace directo al Consecuencias">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="positivas-1">Positivas<a href="#positivas-1" class="hash-link" aria-label="Enlace directo al Positivas" title="Enlace directo al Positivas">​</a></h4>
<ul>
<li>✅ <strong>Alto rendimiento:</strong> Tiempos de validación sub-10ms</li>
<li>✅ <strong>Escalabilidad:</strong> Sin cuello de botella central de validación</li>
<li>✅ <strong>Seguridad:</strong> Protección criptográfica estándar de la industria</li>
<li>✅ <strong>Experiencia del desarrollador:</strong> Contexto rico disponible localmente</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="negativas-1">Negativas<a href="#negativas-1" class="hash-link" aria-label="Enlace directo al Negativas" title="Enlace directo al Negativas">​</a></h4>
<ul>
<li>❌ <strong>Tamaño de token:</strong> ~2KB vs 32 bytes para tokens opacos</li>
<li>❌ <strong>Complejidad de revocación:</strong> Sin capacidad de revocación inmediata</li>
<li>❌ <strong>Gestión de claves:</strong> Complejidad de rotación de claves RSA</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mitigaciones-1">Mitigaciones<a href="#mitigaciones-1" class="hash-link" aria-label="Enlace directo al Mitigaciones" title="Enlace directo al Mitigaciones">​</a></h4>
<ul>
<li>🔧 <strong>Compresión:</strong> Compresión gzip para transporte HTTP</li>
<li>🔧 <strong>TTL corto:</strong> Tiempo de vida del token de 15 minutos</li>
<li>🔧 <strong>Caché de lista negra:</strong> Redis lista negra para tokens revocados</li>
<li>🔧 <strong>Rotación automatizada:</strong> AWS KMS para gestión de claves</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adr-003-multi-realm-strategy-para-aislamiento-multi-tenant">ADR-003: Multi-Realm Strategy para Aislamiento Multi-Tenant<a href="#adr-003-multi-realm-strategy-para-aislamiento-multi-tenant" class="hash-link" aria-label="Enlace directo al ADR-003: Multi-Realm Strategy para Aislamiento Multi-Tenant" title="Enlace directo al ADR-003: Multi-Realm Strategy para Aislamiento Multi-Tenant">​</a></h2>
<table><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody><tr><td><strong>Estado</strong></td><td>✅ Aprobado</td></tr><tr><td><strong>Fecha</strong></td><td>2024-02-01</td></tr><tr><td><strong>Decidido por</strong></td><td>Product Team + Compliance Officer</td></tr><tr><td><strong>Impacto</strong></td><td>High - Affects all tenant operations</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contexto-2">Contexto<a href="#contexto-2" class="hash-link" aria-label="Enlace directo al Contexto" title="Enlace directo al Contexto">​</a></h3>
<p>La organización opera en 4 países con requisitos específicos:</p>
<ul>
<li><strong>Data residency:</strong> Regulaciones locales de protección de datos</li>
<li><strong>Custom branding:</strong> Identidad visual por país</li>
<li><strong>Different integrations:</strong> LDAP/AD específicos por región</li>
<li><strong>Isolated user management:</strong> Administradores locales por país</li>
<li><strong>Compliance:</strong> Auditorías independientes por jurisdicción</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alternativas-consideradas-2">Alternativas Consideradas<a href="#alternativas-consideradas-2" class="hash-link" aria-label="Enlace directo al Alternativas Consideradas" title="Enlace directo al Alternativas Consideradas">​</a></h3>
<table><thead><tr><th>Estrategia</th><th>Isolation Level</th><th>Pros</th><th>Contras</th><th>Decisión</th></tr></thead><tbody><tr><td><strong>Single Realm + Groups</strong></td><td>Logical</td><td>Simple management</td><td>Limited isolation</td><td>❌ Rechazado</td></tr><tr><td><strong>Multiple Realms</strong></td><td>Complete</td><td>Full isolation</td><td>Complex operations</td><td>✅ <strong>Seleccionado</strong></td></tr><tr><td><strong>Separate Keycloak Instances</strong></td><td>Physical</td><td>Ultimate isolation</td><td>High operational cost</td><td>❌ Rechazado</td></tr><tr><td><strong>Hybrid (Master + Country realms)</strong></td><td>Mixed</td><td>Balanced approach</td><td>Complex design</td><td>❌ Rechazado</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decisión-2">Decisión<a href="#decisión-2" class="hash-link" aria-label="Enlace directo al Decisión" title="Enlace directo al Decisión">​</a></h3>
<p><strong>Implementar un realm Keycloak separado por tenant/país</strong> con configuración independiente.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arquitectura-de-realms">Arquitectura de Realms<a href="#arquitectura-de-realms" class="hash-link" aria-label="Enlace directo al Arquitectura de Realms" title="Enlace directo al Arquitectura de Realms">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Keycloak Realm Structure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">master</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">purpose</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Administrative realm only&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;System administrators&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">access</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Super-admin operations&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">peru-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">display_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Talma Perú&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">integrations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;peru-ad.talma.pe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Google Workspace @talma.pe&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">locale</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;es-PE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">currency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PEN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ecuador-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">display_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Talma Ecuador&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">integrations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ecuador-ad.talma.ec&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">locale</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;es-EC&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">currency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;USD&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">colombia-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">display_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Talma Colombia&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">integrations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;colombia-ad.talma.co&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">locale</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;es-CO&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">currency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;COP&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">mexico-realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">display_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Talma México&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">integrations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;mexico-ad.talma.mx&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">locale</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;es-MX&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">currency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MXN&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tenant-resolution-strategy">Tenant Resolution Strategy<a href="#tenant-resolution-strategy" class="hash-link" aria-label="Enlace directo al Tenant Resolution Strategy" title="Enlace directo al Tenant Resolution Strategy">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TenantResolver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ResolveTenant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpContext</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Priority: JWT claim &gt; Header &gt; Subdomain &gt; Default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> jwtTenant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">User</span><span class="token punctuation" style="color:#393A34">?.</span><span class="token function" style="color:#d73a49">FindFirst</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tenant&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">?.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsNullOrEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jwtTenant</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> jwtTenant</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> headerTenant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;X-Tenant-ID&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FirstOrDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsNullOrEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headerTenant</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> headerTenant</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Host</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;peru.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;peru&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ecuador.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ecuador&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;colombia.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;colombia&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mexico.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mexico&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="justificación-2">Justificación<a href="#justificación-2" class="hash-link" aria-label="Enlace directo al Justificación" title="Enlace directo al Justificación">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="compliance">Compliance<a href="#compliance" class="hash-link" aria-label="Enlace directo al Compliance" title="Enlace directo al Compliance">​</a></h4>
<ul>
<li><strong>Data residency:</strong> Complete data isolation per country</li>
<li><strong>Audit trails:</strong> Independent audit logs per jurisdiction</li>
<li><strong>Local administration:</strong> Country-specific admin privileges</li>
<li><strong>Regulatory compliance:</strong> GDPR, local data protection laws</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="operational">Operational<a href="#operational" class="hash-link" aria-label="Enlace directo al Operational" title="Enlace directo al Operational">​</a></h4>
<ul>
<li><strong>Independent configuration:</strong> Separate authentication policies</li>
<li><strong>Custom branding:</strong> Country-specific themes and localization</li>
<li><strong>Isolated failures:</strong> Issues in one realm don&#x27;t affect others</li>
<li><strong>Scalable management:</strong> Dedicated administrators per country</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="security">Security<a href="#security" class="hash-link" aria-label="Enlace directo al Security" title="Enlace directo al Security">​</a></h4>
<ul>
<li>
<p><strong>Blast radius limitation:</strong> Security incidents contained per realm</p>
</li>
<li>
<p><strong>Independent credentials:</strong> No cross-tenant credential sharing</p>
</li>
<li>
<p><strong>Separate certificates:</strong> Country-specific SSL certificates</p>
</li>
<li>
<p><strong>Isolated integrations:</strong> Different LDAP/AD per country</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consecuencias-2">Consecuencias<a href="#consecuencias-2" class="hash-link" aria-label="Enlace directo al Consecuencias" title="Enlace directo al Consecuencias">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="positivas-2">Positivas<a href="#positivas-2" class="hash-link" aria-label="Enlace directo al Positivas" title="Enlace directo al Positivas">​</a></h4>
<ul>
<li>
<p>✅ <strong>Perfect isolation:</strong> Zero data cross-contamination</p>
</li>
<li>
<p>✅ <strong>Compliance ready:</strong> Meets all regulatory requirements</p>
</li>
<li>
<p>✅ <strong>Customization freedom:</strong> Independent configuration per tenant</p>
</li>
<li>
<p>✅ <strong>Scalable growth:</strong> Linear scaling per country</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="negativas-2">Negativas<a href="#negativas-2" class="hash-link" aria-label="Enlace directo al Negativas" title="Enlace directo al Negativas">​</a></h4>
<ul>
<li>❌ <strong>Operational complexity:</strong> 4x management overhead</li>
<li>❌ <strong>Resource overhead:</strong> Separate connection pools, caches</li>
<li>❌ <strong>Cross-tenant queries:</strong> Complex reporting across realms</li>
<li>❌ <strong>Configuration drift:</strong> Potential inconsistencies</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mitigaciones-2">Mitigaciones<a href="#mitigaciones-2" class="hash-link" aria-label="Enlace directo al Mitigaciones" title="Enlace directo al Mitigaciones">​</a></h4>
<ul>
<li>🔧 <strong>Automation:</strong> Terraform modules for realm provisioning</li>
<li>🔧 <strong>Configuration templates:</strong> Standardized base configurations</li>
<li>🔧 <strong>Monitoring:</strong> Unified monitoring across all realms</li>
<li>🔧 <strong>Documentation:</strong> Comprehensive operational procedures</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adr-004-redis-cluster-para-token-validation-caching">ADR-004: Redis Cluster para Token Validation Caching<a href="#adr-004-redis-cluster-para-token-validation-caching" class="hash-link" aria-label="Enlace directo al ADR-004: Redis Cluster para Token Validation Caching" title="Enlace directo al ADR-004: Redis Cluster para Token Validation Caching">​</a></h2>
<table><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody><tr><td><strong>Estado</strong></td><td>✅ Aprobado</td></tr><tr><td><strong>Fecha</strong></td><td>2024-02-10</td></tr><tr><td><strong>Decidido por</strong></td><td>Performance Team + Site Reliability</td></tr><tr><td><strong>Relacionado con</strong></td><td>ADR-002 (JWT Tokens)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contexto-3">Contexto<a href="#contexto-3" class="hash-link" aria-label="Enlace directo al Contexto" title="Enlace directo al Contexto">​</a></h3>
<p>Initial performance testing reveló:</p>
<ul>
<li><strong>JWT validation:</strong> 45-60ms per token (RSA signature verification)</li>
<li><strong>Target latency:</strong> <code>&lt;10ms</code> for token validation</li>
<li><strong>Peak load:</strong> 10,000 validations/second</li>
<li><strong>Disponibilidad requirement:</strong> 99.9% uptime</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problema">Problema<a href="#problema" class="hash-link" aria-label="Enlace directo al Problema" title="Enlace directo al Problema">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Without caching:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- CPU intensive: RSA signature verification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Network latency: JWKS endpoint calls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Scalability issue: Linear degradation with load</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Cost impact: Higher compute requirements</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alternativas-consideradas-3">Alternativas Consideradas<a href="#alternativas-consideradas-3" class="hash-link" aria-label="Enlace directo al Alternativas Consideradas" title="Enlace directo al Alternativas Consideradas">​</a></h3>
<table><thead><tr><th>Solution</th><th>Pros</th><th>Contras</th><th>Performance</th><th>Decisión</th></tr></thead><tbody><tr><td><strong>No caching</strong></td><td>Simple</td><td>Poor performance</td><td>60ms</td><td>❌ Rechazado</td></tr><tr><td><strong>In-memory cache</strong></td><td>Fast</td><td>No sharing across instances</td><td>5ms</td><td>❌ Rechazado</td></tr><tr><td><strong>Redis single</strong></td><td>Distributed</td><td>Single point of failure</td><td>8ms</td><td>❌ Rechazado</td></tr><tr><td><strong>Redis Cluster</strong></td><td>HA + distributed</td><td>Complex setup</td><td>7ms</td><td>✅ <strong>Seleccionado</strong></td></tr><tr><td><strong>DynamoDB</strong></td><td>Managed</td><td>Higher latency</td><td>15ms</td><td>❌ Rechazado</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decisión-3">Decisión<a href="#decisión-3" class="hash-link" aria-label="Enlace directo al Decisión" title="Enlace directo al Decisión">​</a></h3>
<p><strong>Implementar Redis Cluster para distributed caching</strong> de metadatos de validación de tokens.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cache-strategy">Cache Strategy<a href="#cache-strategy" class="hash-link" aria-label="Enlace directo al Cache Strategy" title="Enlace directo al Cache Strategy">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Caching Layers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">L1_Local_Memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Technology</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .NET MemoryCache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">TTL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5 minutes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 100MB per instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Purpose</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Hot token validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">L2_Distributed_Redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Technology</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Redis Cluster (3 masters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 3 replicas)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">TTL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Token expiration time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2GB total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Purpose</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cross</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">instance sharing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Cache Keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> jwt_signature</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">token_hash</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> validation_result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> jwks_keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">realm</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">kid</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> public_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> user_context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">user_id</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> enriched_claims</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a href="#implementation" class="hash-link" aria-label="Enlace directo al Implementation" title="Enlace directo al Implementation">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TokenValidationCache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token class-name">IMemoryCache</span><span class="token plain"> _localCache</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token class-name">IDistributedCache</span><span class="token plain"> _distributedCache</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token return-type class-name punctuation" style="color:#393A34">&lt;</span><span class="token return-type class-name">ValidationResult</span><span class="token return-type class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetValidationResultAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> tokenHash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// L1 Cache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_localCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TryGetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token interpolation-string string" style="color:#e3116c">$&quot;jwt:</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">{</span><span class="token interpolation-string interpolation expression language-csharp">tokenHash</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">}</span><span class="token interpolation-string string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">out</span><span class="token plain"> </span><span class="token class-name">ValidationResult</span><span class="token plain"> localResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> localResult</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// L2 Cache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> serializedResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> _distributedCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetStringAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token interpolation-string string" style="color:#e3116c">$&quot;jwt:</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">{</span><span class="token interpolation-string interpolation expression language-csharp">tokenHash</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">}</span><span class="token interpolation-string string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializedResult </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> distributedResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">Deserialize</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">ValidationResult</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializedResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Populate L1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _localCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token interpolation-string string" style="color:#e3116c">$&quot;jwt:</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">{</span><span class="token interpolation-string interpolation expression language-csharp">tokenHash</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">}</span><span class="token interpolation-string string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> distributedResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TimeSpan</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromMinutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> distributedResult</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Cache miss</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetValidationResultAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> tokenHash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ValidationResult</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeSpan</span><span class="token plain"> ttl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> serialized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Set in both caches</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> _distributedCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetStringAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token interpolation-string string" style="color:#e3116c">$&quot;jwt:</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">{</span><span class="token interpolation-string interpolation expression language-csharp">tokenHash</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">}</span><span class="token interpolation-string string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serialized</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">DistributedCacheEntryOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AbsoluteExpirationRelativeToNow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ttl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _localCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token interpolation-string string" style="color:#e3116c">$&quot;jwt:</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">{</span><span class="token interpolation-string interpolation expression language-csharp">tokenHash</span><span class="token interpolation-string interpolation punctuation" style="color:#393A34">}</span><span class="token interpolation-string string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TimeSpan</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromMinutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure-configuration">Infrastructure Configuration<a href="#infrastructure-configuration" class="hash-link" aria-label="Enlace directo al Infrastructure Configuration" title="Enlace directo al Infrastructure Configuration">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Redis Cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Masters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Instance_Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cache.r6g.large</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 12.93 GB per node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Configuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">maxmemory-policy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> allkeys</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lru</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tcp-keepalive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Backup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">automatic_backup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">backup_retention</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">backup_window</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;03:00-05:00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Monitoring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cloudwatch_metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">slowlog_enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cpu_threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 80%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">memory_threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 85%</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="justificación-3">Justificación<a href="#justificación-3" class="hash-link" aria-label="Enlace directo al Justificación" title="Enlace directo al Justificación">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="performance-impact">Performance Impact<a href="#performance-impact" class="hash-link" aria-label="Enlace directo al Performance Impact" title="Enlace directo al Performance Impact">​</a></h4>
<ul>
<li>
<p><strong>Latency improvement:</strong> 60ms → 7ms (88% reduction)</p>
</li>
<li>
<p><strong>Capacidad de procesamiento increase:</strong> 10x higher req/sec capacity</p>
</li>
<li>
<p><strong>CPU savings:</strong> 70% reduction in validation CPU usage</p>
</li>
<li>
<p><strong>Cost optimization:</strong> Smaller instance types needed</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="reliability">Reliability<a href="#reliability" class="hash-link" aria-label="Enlace directo al Reliability" title="Enlace directo al Reliability">​</a></h4>
<ul>
<li><strong>High disponibilidad:</strong> Redis Cluster automatic failover</li>
<li><strong>Data persistence:</strong> AOF + RDB backup strategies</li>
<li><strong>Graceful degradation:</strong> Fallback to direct validation</li>
<li><strong>Monitoring:</strong> Comprehensive CloudWatch metrics</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consecuencias-3">Consecuencias<a href="#consecuencias-3" class="hash-link" aria-label="Enlace directo al Consecuencias" title="Enlace directo al Consecuencias">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="positivas-3">Positivas<a href="#positivas-3" class="hash-link" aria-label="Enlace directo al Positivas" title="Enlace directo al Positivas">​</a></h4>
<ul>
<li>✅ <strong>Dramatic performance improvement:</strong> Sub-10ms validation</li>
<li>✅ <strong>Cost optimization:</strong> Reduced compute requirements</li>
<li>✅ <strong>Scalability:</strong> Handles peak loads efficiently</li>
<li>✅ <strong>High disponibilidad:</strong> Cluster resilience</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="negativas-3">Negativas<a href="#negativas-3" class="hash-link" aria-label="Enlace directo al Negativas" title="Enlace directo al Negativas">​</a></h4>
<ul>
<li>❌ <strong>Additional complexity:</strong> Cache invalidation logic</li>
<li>❌ <strong>Operational overhead:</strong> Redis cluster management</li>
<li>❌ <strong>Dependency risk:</strong> Cache unavailability impact</li>
<li>❌ <strong>Memory costs:</strong> Additional infrastructure costs</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mitigaciones-3">Mitigaciones<a href="#mitigaciones-3" class="hash-link" aria-label="Enlace directo al Mitigaciones" title="Enlace directo al Mitigaciones">​</a></h4>
<ul>
<li>🔧 <strong>Fallback logic:</strong> Direct validation when cache unavailable</li>
<li>🔧 <strong>Health checks:</strong> Proactive cache monitoreo de salud</li>
<li>🔧 <strong>Automated scaling:</strong> Auto-scaling based on memory usage</li>
<li>🔧 <strong>Runbooks:</strong> Detailed operational procedures</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adr-005-event-sourcing-para-audit-trail-compliance">ADR-005: Event Sourcing para Audit Trail Compliance<a href="#adr-005-event-sourcing-para-audit-trail-compliance" class="hash-link" aria-label="Enlace directo al ADR-005: Event Sourcing para Audit Trail Compliance" title="Enlace directo al ADR-005: Event Sourcing para Audit Trail Compliance">​</a></h2>
<table><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody><tr><td><strong>Estado</strong></td><td>✅ Aprobado</td></tr><tr><td><strong>Fecha</strong></td><td>2024-02-15</td></tr><tr><td><strong>Decidido por</strong></td><td>Compliance Officer + Data Architect</td></tr><tr><td><strong>Regulatory drivers</strong></td><td>GDPR, SOX, ISO 27001</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contexto-4">Contexto<a href="#contexto-4" class="hash-link" aria-label="Enlace directo al Contexto" title="Enlace directo al Contexto">​</a></h3>
<p>Compliance requirements demandan:</p>
<ul>
<li><strong>Complete audit trail:</strong> Every identity operation must be logged</li>
<li><strong>Immutable records:</strong> Audit logs cannot be modified</li>
<li><strong>Long-term retention:</strong> 7 years for financial compliance</li>
<li><strong>Real-time monitoring:</strong> Immediate security event detection</li>
<li><strong>Forensic analysis:</strong> Detailed investigation capabilities</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="traditional-vs-event-sourcing">Traditional vs Event Sourcing<a href="#traditional-vs-event-sourcing" class="hash-link" aria-label="Enlace directo al Traditional vs Event Sourcing" title="Enlace directo al Traditional vs Event Sourcing">​</a></h3>
<table><thead><tr><th>Aspect</th><th>Traditional Logging</th><th>Event Sourcing</th><th>Decision</th></tr></thead><tbody><tr><td><strong>Immutability</strong></td><td>Files can be modified</td><td>Events are immutable</td><td>✅ Event Sourcing</td></tr><tr><td><strong>Completeness</strong></td><td>Limited to what&#x27;s logged</td><td>Complete state changes</td><td>✅ Event Sourcing</td></tr><tr><td><strong>Time travel</strong></td><td>Not possible</td><td>Full history replay</td><td>✅ Event Sourcing</td></tr><tr><td><strong>Compliance</strong></td><td>Basic</td><td>Full auditability</td><td>✅ Event Sourcing</td></tr><tr><td><strong>Complexity</strong></td><td>Simple</td><td>More complex</td><td>Acceptable trade-off</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decisión-4">Decisión<a href="#decisión-4" class="hash-link" aria-label="Enlace directo al Decisión" title="Enlace directo al Decisión">​</a></h3>
<p><strong>Implementar Event Sourcing pattern</strong> para audit trail y compliance reporting.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="event-store-architecture">Event Store Architecture<a href="#event-store-architecture" class="hash-link" aria-label="Enlace directo al Event Store Architecture" title="Enlace directo al Event Store Architecture">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Event Store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Primary</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PostgreSQL with JSONB events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Stream</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Event Bus agnóstico para procesamiento en tiempo real</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Archive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AWS S3 for long</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">term storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Analytics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AWS Athena for querying archived events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Event Categories</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Authentication</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> UserLoginAttempted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> UserLoggedIn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> UserLogoutInitiated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> MfaChallengeSent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> MfaChallengeCompleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Authorization</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PermissionGranted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PermissionDenied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> RoleAssigned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> RoleRevoked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Administration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> UserCreated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> UserModified</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> UserDeactivated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ConfigurationChanged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Compliance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DataExported</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DataDeleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ConsentGranted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ConsentRevoked</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="event-schema-design">Event Schema Design<a href="#event-schema-design" class="hash-link" aria-label="Enlace directo al Event Schema Design" title="Enlace directo al Event Schema Design">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">abstract</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">IdentityEvent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name">Guid</span><span class="token plain"> EventId </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Guid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewGuid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> StreamId </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// User ID or Admin ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> EventType </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name">DateTime</span><span class="token plain"> Timestamp </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UtcNow</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> TenantId </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> UserId </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> SessionId </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> ClientIP </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> UserAgent </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">object</span><span class="token plain"> Metadata </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">object</span><span class="token plain"> Data </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Specific event example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UserLoggedInEvent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token type-list class-name">IdentityEvent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> AuthenticationMethod </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// password, mfa, federated</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">bool</span><span class="token plain"> MfaUsed </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name">TimeSpan</span><span class="token plain"> LoginDuration </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> DeviceFingerprint </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name">GeoLocation</span><span class="token plain"> Location </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RoleAssignedEvent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token type-list class-name">IdentityEvent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> RoleName </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> AssignedByUserId </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name">DateTime</span><span class="token return-type class-name punctuation" style="color:#393A34">?</span><span class="token plain"> ExpiresAt </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">string</span><span class="token plain"> Justification </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="event-store-implementation">Event Store Implementation<a href="#event-store-implementation" class="hash-link" aria-label="Enlace directo al Event Store Implementation" title="Enlace directo al Event Store Implementation">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PostgreSQLEventStore</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token type-list class-name">IEventStore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token class-name">NpgsqlConnection</span><span class="token plain"> _connection</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AppendEventsAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> streamId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IEnumerable</span><span class="token class-name punctuation" style="color:#393A34">&lt;</span><span class="token class-name">IdentityEvent</span><span class="token class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> transaction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> _connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BeginTransactionAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> @</span><span class="token keyword" style="color:#00009f">event</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> _connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ExecuteAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">@&quot;INSERT INTO event_store (</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        event_id, stream_id, event_type, event_version,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        timestamp, tenant_id, user_id, session_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        client_ip, user_agent, event_data, metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ) VALUES (</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        @EventId, @StreamId, @EventType, @EventVersion,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        @Timestamp, @TenantId, @UserId, @SessionId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        @ClientIP, @UserAgent, @EventData::jsonb, @Metadata::jsonb</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    )&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        StreamId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> streamId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        EventVersion </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetNextVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streamId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TenantId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UserId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SessionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientIP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UserAgent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        EventData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Metadata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Metadata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CommitAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RollbackAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="real-time-event-processing">Real-time Event Processing<a href="#real-time-event-processing" class="hash-link" aria-label="Enlace directo al Real-time Event Processing" title="Enlace directo al Real-time Event Processing">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SecurityEventProcessor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token class-name">IKafkaProducer</span><span class="token plain"> _producer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token class-name">ISecurityAnalyzer</span><span class="token plain"> _analyzer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ProcessEventAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IdentityEvent</span><span class="token plain"> @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Immediate security analysis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> threatLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> _analyzer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AnalyzeThreatLevelAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threatLevel </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> ThreatLevel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">High</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SendSecurityAlertAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> threatLevel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Stream to Kafka for downstream processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> _producer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProduceAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;identity-events&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Message</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">&lt;</span><span class="token constructor-invocation class-name keyword" style="color:#00009f">string</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">,</span><span class="token constructor-invocation class-name"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">string</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> @</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Update dashboards en tiempo real</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UpdateSecurityDashboardAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token keyword" style="color:#00009f">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="justificación-4">Justificación<a href="#justificación-4" class="hash-link" aria-label="Enlace directo al Justificación" title="Enlace directo al Justificación">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="compliance-benefits">Compliance Benefits<a href="#compliance-benefits" class="hash-link" aria-label="Enlace directo al Compliance Benefits" title="Enlace directo al Compliance Benefits">​</a></h4>
<ul>
<li>
<p><strong>Immutable audit trail:</strong> Events cannot be modified or deleted</p>
</li>
<li>
<p><strong>Complete history:</strong> Every state change is captured</p>
</li>
<li>
<p><strong>Temporal queries:</strong> Point-in-time system state reconstruction</p>
</li>
<li>
<p><strong>Regulatory compliance:</strong> Meets SOX, GDPR, ISO 27001 requirements</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="security-benefits">Security Benefits<a href="#security-benefits" class="hash-link" aria-label="Enlace directo al Security Benefits" title="Enlace directo al Security Benefits">​</a></h4>
<ul>
<li>
<p><strong>Real-time monitoring:</strong> Immediate security event detection</p>
</li>
<li>
<p><strong>Forensic analysis:</strong> Detailed investigation capabilities</p>
</li>
<li>
<p><strong>Anomaly detection:</strong> Pattern analysis across event streams</p>
</li>
<li>
<p><strong>Incident response:</strong> Complete attack timeline reconstruction</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="operational-benefits">Operational Benefits<a href="#operational-benefits" class="hash-link" aria-label="Enlace directo al Operational Benefits" title="Enlace directo al Operational Benefits">​</a></h4>
<ul>
<li><strong>System debugging:</strong> Event replay for resolución de problemas</li>
<li><strong>Business analytics:</strong> User behavior analysis</li>
<li><strong>Performance monitoring:</strong> System usage patterns</li>
<li><strong>Data recovery:</strong> State reconstruction from events</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consecuencias-4">Consecuencias<a href="#consecuencias-4" class="hash-link" aria-label="Enlace directo al Consecuencias" title="Enlace directo al Consecuencias">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="positivas-4">Positivas<a href="#positivas-4" class="hash-link" aria-label="Enlace directo al Positivas" title="Enlace directo al Positivas">​</a></h4>
<ul>
<li>
<p>✅ <strong>Regulatory compliance:</strong> Full audit trail compliance</p>
</li>
<li>
<p>✅ <strong>Security enhancement:</strong> Real-time threat detection</p>
</li>
<li>
<p>✅ <strong>Forensic capabilities:</strong> Complete investigation data</p>
</li>
<li>
<p>✅ <strong>System reliability:</strong> Event replay for debugging</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="negativas-4">Negativas<a href="#negativas-4" class="hash-link" aria-label="Enlace directo al Negativas" title="Enlace directo al Negativas">​</a></h4>
<ul>
<li>
<p>❌ <strong>Storage costs:</strong> Long-term event storage requirements</p>
</li>
<li>
<p>❌ <strong>Complexity increase:</strong> Event sourcing learning curve</p>
</li>
<li>
<p>❌ <strong>Query complexity:</strong> Event-based queries vs traditional SQL</p>
</li>
<li>
<p>❌ <strong>Performance overhead:</strong> Event append latency</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mitigaciones-4">Mitigaciones<a href="#mitigaciones-4" class="hash-link" aria-label="Enlace directo al Mitigaciones" title="Enlace directo al Mitigaciones">​</a></h4>
<ul>
<li>
<p>🔧 <strong>Tiered storage:</strong> Hot/warm/cold storage strategy</p>
</li>
<li>
<p>🔧 <strong>Training program:</strong> Team education on event sourcing</p>
</li>
<li>
<p>🔧 <strong>CQRS pattern:</strong> Separate read models for queries</p>
</li>
<li>
<p>🔧 <strong>Async processing:</strong> Non-blocking event append operations</p>
</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resumen-de-decisiones">Resumen de Decisiones<a href="#resumen-de-decisiones" class="hash-link" aria-label="Enlace directo al Resumen de Decisiones" title="Enlace directo al Resumen de Decisiones">​</a></h2>
<p>| ADR | Decisión | Impacto | Estado |</p>
<p>|-----|----------|---------|--------|
| <strong>ADR-001</strong> | Keycloak como IdP | Alto | ✅ Implementado |</p>
<p>| <strong>ADR-002</strong> | JWT RS256 tokens | Alto | ✅ Implementado |
| <strong>ADR-003</strong> | Multi-realm multi-tenancy | Alto | ✅ Implementado |</p>
<p>| <strong>ADR-004</strong> | Redis caching | Medio | ✅ Implementado |
| <strong>ADR-005</strong> | Event sourcing audit | Alto | ✅ Implementado |</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dependency-graph">Dependency Graph<a href="#dependency-graph" class="hash-link" aria-label="Enlace directo al Dependency Graph" title="Enlace directo al Dependency Graph">​</a></h3>
<!-- -->
<p><em>[INSERTAR AQUÍ: Diagrama C4 - ADR Implementation Overview]</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="referencias">Referencias<a href="#referencias" class="hash-link" aria-label="Enlace directo al Referencias" title="Enlace directo al Referencias">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adr-format">ADR Format<a href="#adr-format" class="hash-link" aria-label="Enlace directo al ADR Format" title="Enlace directo al ADR Format">​</a></h3>
<ul>
<li><a href="https://adr.github.io/" target="_blank" rel="noopener noreferrer">Architecture Decision Records (ADRs)</a></li>
<li><a href="https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions" target="_blank" rel="noopener noreferrer">Documenting Decisiones de Arquitectura</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-references">Implementation References<a href="#implementation-references" class="hash-link" aria-label="Enlace directo al Implementation References" title="Enlace directo al Implementation References">​</a></h3>
<ul>
<li><a href="https://www.keycloak.org/documentation" target="_blank" rel="noopener noreferrer">Keycloak Documentation</a></li>
<li><a href="https://tools.ietf.org/html/rfc8725" target="_blank" rel="noopener noreferrer">JWT Mejores Prácticas</a></li>
<li><a href="https://martinfowler.com/eaaDev/EventSourcing.html" target="_blank" rel="noopener noreferrer">Event Sourcing Pattern</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="compliance-standards">Compliance Standards<a href="#compliance-standards" class="hash-link" aria-label="Enlace directo al Compliance Standards" title="Enlace directo al Compliance Standards">​</a></h3>
<ul>
<li><a href="https://gdpr.eu/compliance/" target="_blank" rel="noopener noreferrer">GDPR Compliance Guide</a></li>
<li><a href="https://www.sox-online.com/sox_it_controls.html" target="_blank" rel="noopener noreferrer">SOX IT Controls</a></li>
<li><a href="https://www.iso.org/isoiec-27001-information-security.html" target="_blank" rel="noopener noreferrer">ISO 27001 Information Security</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contexto-5">Contexto<a href="#contexto-5" class="hash-link" aria-label="Enlace directo al Contexto" title="Enlace directo al Contexto">​</a></h3>
<p>Requerimientos regulatorios exigen trazabilidad completa de eventos de seguridad.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decisión-5">Decisión<a href="#decisión-5" class="hash-link" aria-label="Enlace directo al Decisión" title="Enlace directo al Decisión">​</a></h3>
<p>Implementar Event Sourcing con Event Store agnóstico para audit trail.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="justificación-5">Justificación<a href="#justificación-5" class="hash-link" aria-label="Enlace directo al Justificación" title="Enlace directo al Justificación">​</a></h3>
<ul>
<li><strong>Immutability:</strong> Eventos inmutables para compliance</li>
<li><strong>Completeness:</strong> Captura de todos los eventos</li>
<li><strong>Scalability:</strong> Kafka maneja alto volumen</li>
<li><strong>Real-time:</strong> Procesamiento en tiempo real</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consecuencias-5">Consecuencias<a href="#consecuencias-5" class="hash-link" aria-label="Enlace directo al Consecuencias" title="Enlace directo al Consecuencias">​</a></h3>
<ul>
<li><strong>Positivas:</strong> Compliance total, analytics avanzados</li>
<li><strong>Negativas:</strong> Complejidad de implementación</li>
<li><strong>Mitigaciones:</strong> Bibliotecas de abstracción, tooling</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resumen-de-decisiones-1">Resumen de Decisiones<a href="#resumen-de-decisiones-1" class="hash-link" aria-label="Enlace directo al Resumen de Decisiones" title="Enlace directo al Resumen de Decisiones">​</a></h2>
<table><thead><tr><th>Decisión</th><th>Alternativas Evaluadas</th><th>Estado</th><th>Impacto</th></tr></thead><tbody><tr><td>Keycloak</td><td>Auth0, AWS Cognito, Azure AD B2C</td><td>Aprobado</td><td>Alto</td></tr><tr><td>JWT Tokens</td><td>SAML, Opaque tokens</td><td>Aprobado</td><td>Alto</td></tr><tr><td>Multi-Realm</td><td>Shared realm con atributos</td><td>Aprobado</td><td>Medio</td></tr><tr><td>Redis Cache</td><td>In-memory, Database cache</td><td>Aprobado</td><td>Medio</td></tr><tr><td>Event Sourcing</td><td>Traditional auditing</td><td>Aprobado</td><td>Alto</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="referencias-1">Referencias<a href="#referencias-1" class="hash-link" aria-label="Enlace directo al Referencias" title="Enlace directo al Referencias">​</a></h2>
<ul>
<li><a href="https://adr.github.io/" target="_blank" rel="noopener noreferrer">Architecture Decision Records</a></li>
<li><a href="https://www.keycloak.org/docs/latest/server_development/" target="_blank" rel="noopener noreferrer">Keycloak Architecture Guide</a></li>
<li><a href="https://tools.ietf.org/html/rfc8725" target="_blank" rel="noopener noreferrer">JWT Mejores Prácticas</a></li>
<li><a href="https://docs.arc42.org/section-9/" target="_blank" rel="noopener noreferrer">Arc42 Decisiones de Arquitectura</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/jclemente-tlm/tlm-doc-architecture/edit/main/docs/servicios-corporativos/servicio-identidad/09-decisiones-arquitectura.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Editar esta página</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Página del documento"><a class="pagination-nav__link pagination-nav__link--prev" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/conceptos-transversales"><div class="pagination-nav__sublabel">Anterior</div><div class="pagination-nav__label">8. Conceptos Transversales</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tlm-doc-architecture/docs/servicios-corporativos/servicio-identidad/requisitos-calidad"><div class="pagination-nav__sublabel">Siguiente</div><div class="pagination-nav__label">10. Requisitos De Calidad</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#91-decisiones-principales" class="table-of-contents__link toc-highlight">9.1 Decisiones Principales</a></li><li><a href="#92-alternativas-evaluadas" class="table-of-contents__link toc-highlight">9.2 Alternativas Evaluadas</a></li><li><a href="#93-resumen-de-decisiones" class="table-of-contents__link toc-highlight">9.3 Resumen de Decisiones</a></li><li><a href="#94-principios-arquitectónicos" class="table-of-contents__link toc-highlight">9.4 Principios Arquitectónicos</a></li><li><a href="#95-referencias" class="table-of-contents__link toc-highlight">9.5 Referencias</a></li><li><a href="#91-decisiones-principales-1" class="table-of-contents__link toc-highlight">9.1 Decisiones principales</a></li><li><a href="#92-alternativas-evaluadas-1" class="table-of-contents__link toc-highlight">9.2 Alternativas evaluadas</a></li><li><a href="#resumen-de-decisiones-arquitectónicas" class="table-of-contents__link toc-highlight">Resumen de Decisiones Arquitectónicas</a><ul><li><a href="#principios-arquitectónicos" class="table-of-contents__link toc-highlight">Principios Arquitectónicos</a></li></ul></li><li><a href="#adr-001-keycloak-containerizado-como-identity-provider-central" class="table-of-contents__link toc-highlight">ADR-001: Keycloak Containerizado como Identity Provider Central</a><ul><li><a href="#contexto" class="table-of-contents__link toc-highlight">Contexto</a></li><li><a href="#alternativas-consideradas" class="table-of-contents__link toc-highlight">Alternativas Consideradas</a></li><li><a href="#decisión" class="table-of-contents__link toc-highlight">Decisión</a></li><li><a href="#arquitectura-containerizada" class="table-of-contents__link toc-highlight">Arquitectura Containerizada</a></li><li><a href="#configuración-multi-tenant-realms" class="table-of-contents__link toc-highlight">Configuración Multi-tenant (Realms)</a></li><li><a href="#justificación" class="table-of-contents__link toc-highlight">Justificación</a></li><li><a href="#implementación-cloud-agnostic" class="table-of-contents__link toc-highlight">Implementación Cloud-Agnostic</a></li><li><a href="#consecuencias" class="table-of-contents__link toc-highlight">Consecuencias</a></li></ul></li><li><a href="#adr-002-jwt-con-rs256-como-formato-de-token-estándar" class="table-of-contents__link toc-highlight">ADR-002: JWT con RS256 como Formato de Token Estándar</a><ul><li><a href="#contexto-1" class="table-of-contents__link toc-highlight">Contexto</a></li><li><a href="#alternativas-consideradas-1" class="table-of-contents__link toc-highlight">Alternativas Consideradas</a></li><li><a href="#decisión-1" class="table-of-contents__link toc-highlight">Decisión</a></li><li><a href="#justificación-1" class="table-of-contents__link toc-highlight">Justificación</a></li><li><a href="#token-structure" class="table-of-contents__link toc-highlight">Token Structure</a></li><li><a href="#key-management-strategy" class="table-of-contents__link toc-highlight">Key Management Strategy</a></li><li><a href="#consecuencias-1" class="table-of-contents__link toc-highlight">Consecuencias</a></li></ul></li><li><a href="#adr-003-multi-realm-strategy-para-aislamiento-multi-tenant" class="table-of-contents__link toc-highlight">ADR-003: Multi-Realm Strategy para Aislamiento Multi-Tenant</a><ul><li><a href="#contexto-2" class="table-of-contents__link toc-highlight">Contexto</a></li><li><a href="#alternativas-consideradas-2" class="table-of-contents__link toc-highlight">Alternativas Consideradas</a></li><li><a href="#decisión-2" class="table-of-contents__link toc-highlight">Decisión</a></li><li><a href="#arquitectura-de-realms" class="table-of-contents__link toc-highlight">Arquitectura de Realms</a></li><li><a href="#tenant-resolution-strategy" class="table-of-contents__link toc-highlight">Tenant Resolution Strategy</a></li><li><a href="#justificación-2" class="table-of-contents__link toc-highlight">Justificación</a></li><li><a href="#consecuencias-2" class="table-of-contents__link toc-highlight">Consecuencias</a></li></ul></li><li><a href="#adr-004-redis-cluster-para-token-validation-caching" class="table-of-contents__link toc-highlight">ADR-004: Redis Cluster para Token Validation Caching</a><ul><li><a href="#contexto-3" class="table-of-contents__link toc-highlight">Contexto</a></li><li><a href="#problema" class="table-of-contents__link toc-highlight">Problema</a></li><li><a href="#alternativas-consideradas-3" class="table-of-contents__link toc-highlight">Alternativas Consideradas</a></li><li><a href="#decisión-3" class="table-of-contents__link toc-highlight">Decisión</a></li><li><a href="#cache-strategy" class="table-of-contents__link toc-highlight">Cache Strategy</a></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a></li><li><a href="#infrastructure-configuration" class="table-of-contents__link toc-highlight">Infrastructure Configuration</a></li><li><a href="#justificación-3" class="table-of-contents__link toc-highlight">Justificación</a></li><li><a href="#consecuencias-3" class="table-of-contents__link toc-highlight">Consecuencias</a></li></ul></li><li><a href="#adr-005-event-sourcing-para-audit-trail-compliance" class="table-of-contents__link toc-highlight">ADR-005: Event Sourcing para Audit Trail Compliance</a><ul><li><a href="#contexto-4" class="table-of-contents__link toc-highlight">Contexto</a></li><li><a href="#traditional-vs-event-sourcing" class="table-of-contents__link toc-highlight">Traditional vs Event Sourcing</a></li><li><a href="#decisión-4" class="table-of-contents__link toc-highlight">Decisión</a></li><li><a href="#event-store-architecture" class="table-of-contents__link toc-highlight">Event Store Architecture</a></li><li><a href="#event-schema-design" class="table-of-contents__link toc-highlight">Event Schema Design</a></li><li><a href="#event-store-implementation" class="table-of-contents__link toc-highlight">Event Store Implementation</a></li><li><a href="#real-time-event-processing" class="table-of-contents__link toc-highlight">Real-time Event Processing</a></li><li><a href="#justificación-4" class="table-of-contents__link toc-highlight">Justificación</a></li><li><a href="#consecuencias-4" class="table-of-contents__link toc-highlight">Consecuencias</a></li></ul></li><li><a href="#resumen-de-decisiones" class="table-of-contents__link toc-highlight">Resumen de Decisiones</a><ul><li><a href="#dependency-graph" class="table-of-contents__link toc-highlight">Dependency Graph</a></li></ul></li><li><a href="#referencias" class="table-of-contents__link toc-highlight">Referencias</a><ul><li><a href="#adr-format" class="table-of-contents__link toc-highlight">ADR Format</a></li><li><a href="#implementation-references" class="table-of-contents__link toc-highlight">Implementation References</a></li><li><a href="#compliance-standards" class="table-of-contents__link toc-highlight">Compliance Standards</a></li><li><a href="#contexto-5" class="table-of-contents__link toc-highlight">Contexto</a></li><li><a href="#decisión-5" class="table-of-contents__link toc-highlight">Decisión</a></li><li><a href="#justificación-5" class="table-of-contents__link toc-highlight">Justificación</a></li><li><a href="#consecuencias-5" class="table-of-contents__link toc-highlight">Consecuencias</a></li></ul></li><li><a href="#resumen-de-decisiones-1" class="table-of-contents__link toc-highlight">Resumen de Decisiones</a></li><li><a href="#referencias-1" class="table-of-contents__link toc-highlight">Referencias</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tlm-doc-architecture/docs/intro">Documentación</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Comunidad</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://pe.linkedin.com/company/talma-servicios-aeroportuarios" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UC-LkTBWGU2aSh-00bv83OlA" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/talmaperu/?ref=br_rs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Más</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/jclemente-tlm/tlm-doc-architecture" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Talma. Documentación construida con Docusaurus.</div></div></div></footer></div>
</body>
</html>